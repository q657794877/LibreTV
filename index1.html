<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 TS路径顺序替换工具</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2a5298);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .card h2 {
            color: #2a5298;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            transition: border 0.3s;
        }
        
        textarea:focus {
            border-color: #2a5298;
            outline: none;
            box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.2);
        }
        
        .input-row {
            display: flex;
            gap: 20px;
        }
        
        .input-col {
            flex: 1;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            background: #2a5298;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
        }
        
        button:hover {
            background: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.copy {
            background: #28a745;
        }
        
        button.copy:hover {
            background: #218838;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.secondary:hover {
            background: #545b62;
        }
        
        button.download {
            background: #dc3545;
        }
        
        button.download:hover {
            background: #c82333;
        }
        
        button.analyze-sequence {
            background: #17a2b8;
        }
        
        button.analyze-sequence:hover {
            background: #138496;
        }
        
        .result-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2a5298;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 5px 5px 0;
        }
        
        .info-box h3 {
            margin-bottom: 10px;
            color: #2a5298;
        }
        
        .info-box ul {
            padding-left: 20px;
        }
        
        .info-box li {
            margin-bottom: 8px;
        }
        
        .detected-paths {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
        }
        
        .detected-paths h4 {
            margin-bottom: 10px;
            color: #17a2b8;
        }
        
        .path-list {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        .path-entry {
            padding: 5px;
            border-bottom: 1px solid #f0f0f0;
            font-family: monospace;
            font-size: 13px;
        }
        
        .path-entry:last-child {
            border-bottom: none;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-label {
            display: block;
            padding: 12px 15px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            text-align: center;
            color: #6c757d;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .file-upload-label:hover {
            background: #e9ecef;
            border-color: #2a5298;
            color: #2a5298;
        }
        
        .range-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .range-control {
            flex: 1;
        }
        
        .range-control input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .sequence-analysis {
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
        }
        
        .sequence-analysis h4 {
            margin-bottom: 10px;
            color: #856404;
        }
        
        .sequence-result {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ffeaa7;
            font-size: 14px;
        }
        
        .missing-numbers {
            color: #dc3545;
            font-weight: bold;
        }
        
        .complete-sequence {
            color: #28a745;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .input-row {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .range-controls {
                flex-direction: column;
            }
            
            header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>M3U8 TS路径顺序替换工具</h1>
            <p>按照M3U8文件中TS出现的顺序替换路径</p>
        </header>
        
        <div class="info-box card">
            <h3>使用说明</h3>
            <ul>
                <li>在左侧文本框中粘贴您的M3U8文件内容，或直接上传M3U8文件</li>
                <li>在右侧文本框中粘贴新的TS路径列表（每行一个路径）</li>
                <li>使用"分析序列"功能检查TS路径的数字连续性</li>
                <li>设置替换范围（可选，默认替换全部）</li>
                <li>点击"替换路径"按钮生成新的M3U8内容</li>
                <li>使用"复制结果"按钮复制生成的内容，或"下载M3U8文件"保存</li>
                <li><strong>注意：</strong>新的TS路径数量必须与替换范围内的TS文件数量相同</li>
                <li><strong>增强功能：</strong>自动检测各种TS文件格式，包括无后缀文件</li>
            </ul>
        </div>
        
        <div class="card">
            <h2>输入内容</h2>
            <div class="input-row">
                <div class="input-col">
                    <div class="file-upload">
                        <label class="file-upload-label">
                            <span>点击上传M3U8文件 或 拖放文件到这里</span>
                            <input type="file" id="file-upload" accept=".m3u8,.txt">
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="m3u8-input">M3U8文件内容:</label>
                        <textarea id="m3u8-input" placeholder="在此粘贴您的M3U8文件内容..."></textarea>
                    </div>
                    <div class="detected-paths">
                        <h4>检测到的TS文件路径:</h4>
                        <div id="detected-paths-list" class="path-list">
                            <div class="path-entry">检测到的路径将显示在这里...</div>
                        </div>
                    </div>
                </div>
                <div class="input-col">
                    <div class="form-group">
                        <label for="new-paths">新的TS路径列表 (每行一个):</label>
                        <textarea id="new-paths" placeholder="在此粘贴新的TS路径，每行一个..."></textarea>
                    </div>
                    <div class="button-group">
                        <button id="analyze-sequence-btn" class="analyze-sequence">分析序列</button>
                        <button id="sort-paths-btn" class="secondary">排序路径</button>
                    </div>
                    <div class="sequence-analysis">
                        <h4>序列分析结果:</h4>
                        <div id="sequence-result" class="sequence-result">
                            序列分析结果将显示在这里...
                        </div>
                    </div>
                    <div class="detected-paths">
                        <h4>新的TS文件路径:</h4>
                        <div id="new-paths-list" class="path-list">
                            <div class="path-entry">新的路径将显示在这里...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>替换范围设置 (可选):</label>
                <div class="range-controls">
                    <div class="range-control">
                        <label for="start-index">起始序号:</label>
                        <input type="number" id="start-index" min="1" value="1" placeholder="从第几个开始替换">
                    </div>
                    <div class="range-control">
                        <label for="end-index">结束序号:</label>
                        <input type="number" id="end-index" min="1" placeholder="替换到第几个">
                    </div>
                </div>
                <div class="result-info">
                    <div id="range-info">默认替换全部TS文件路径</div>
                </div>
            </div>
            
            <div class="button-group">
                <button id="analyze-btn">分析M3U8</button>
                <button id="replace-btn">替换路径</button>
                <button id="clear-btn" class="secondary">清空内容</button>
            </div>
        </div>
        
        <div class="card">
            <h2>替换结果</h2>
            <div class="form-group">
                <label for="m3u8-output">更新后的M3U8内容:</label>
                <textarea id="m3u8-output" readonly placeholder="替换后的内容将显示在这里..."></textarea>
            </div>
            
            <div class="result-info">
                <div id="result-stats">检测到0个TS文件路径</div>
            </div>
            
            <div class="button-group">
                <button id="copy-btn" class="copy">复制结果</button>
                <button id="download-btn" class="download">下载M3U8文件</button>
            </div>
        </div>
    </div>

    <!-- 下载文件名输入模态框 -->
    <div id="download-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>下载M3U8文件</h3>
            </div>
            <div class="modal-body">
                <label for="filename-input">请输入文件名:</label>
                <input type="text" id="filename-input" value="output.m3u8" placeholder="输入文件名">
            </div>
            <div class="modal-footer">
                <button id="cancel-download" class="secondary">取消</button>
                <button id="confirm-download" class="download">确认下载</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const m3u8Input = document.getElementById('m3u8-input');
            const newPathsInput = document.getElementById('new-paths');
            const m3u8Output = document.getElementById('m3u8-output');
            const replaceBtn = document.getElementById('replace-btn');
            const analyzeBtn = document.getElementById('analyze-btn');
            const analyzeSequenceBtn = document.getElementById('analyze-sequence-btn');
            const sortPathsBtn = document.getElementById('sort-paths-btn');
            const copyBtn = document.getElementById('copy-btn');
            const downloadBtn = document.getElementById('download-btn');
            const clearBtn = document.getElementById('clear-btn');
            const fileUpload = document.getElementById('file-upload');
            const startIndexInput = document.getElementById('start-index');
            const endIndexInput = document.getElementById('end-index');
            const rangeInfo = document.getElementById('range-info');
            const resultStats = document.getElementById('result-stats');
            const detectedPathsList = document.getElementById('detected-paths-list');
            const newPathsList = document.getElementById('new-paths-list');
            const sequenceResult = document.getElementById('sequence-result');
            const downloadModal = document.getElementById('download-modal');
            const filenameInput = document.getElementById('filename-input');
            const cancelDownload = document.getElementById('cancel-download');
            const confirmDownload = document.getElementById('confirm-download');
            
            let tsPaths = [];
            
            // 文件上传处理
            fileUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    m3u8Input.value = e.target.result;
                    analyzeBtn.click();
                };
                reader.readAsText(file);
            });
            
            // 拖放文件支持
            const fileUploadLabel = document.querySelector('.file-upload-label');
            fileUploadLabel.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileUploadLabel.style.background = '#e9ecef';
                fileUploadLabel.style.borderColor = '#2a5298';
            });
            
            fileUploadLabel.addEventListener('dragleave', function(e) {
                e.preventDefault();
                fileUploadLabel.style.background = '#f8f9fa';
                fileUploadLabel.style.borderColor = '#dee2e6';
            });
            
            fileUploadLabel.addEventListener('drop', function(e) {
                e.preventDefault();
                fileUploadLabel.style.background = '#f8f9fa';
                fileUploadLabel.style.borderColor = '#dee2e6';
                
                const file = e.dataTransfer.files[0];
                if (!file) return;
                
                // 检查文件类型
                if (!file.name.endsWith('.m3u8') && !file.name.endsWith('.txt')) {
                    alert('请上传M3U8文件或文本文件');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    m3u8Input.value = e.target.result;
                    analyzeBtn.click();
                };
                reader.readAsText(file);
            });
            
            // 分析M3U8文件
            analyzeBtn.addEventListener('click', function() {
                const m3u8Content = m3u8Input.value.trim();
                
                if (!m3u8Content) {
                    alert('请输入M3U8文件内容');
                    return;
                }
                
                tsPaths = extractTSPaths(m3u8Content);
                displayPaths(tsPaths, detectedPathsList);
                resultStats.textContent = `检测到 ${tsPaths.length} 个TS文件路径`;
                
                // 更新范围信息
                updateRangeInfo();
            });
            
            // 分析序列
            analyzeSequenceBtn.addEventListener('click', function() {
                const newPathsText = newPathsInput.value.trim();
                
                if (!newPathsText) {
                    alert('请输入新的TS路径列表');
                    return;
                }
                
                const newPaths = newPathsText.split('\n')
                    .map(path => path.trim())
                    .filter(path => path !== '');
                
                const analysis = analyzePathSequence(newPaths);
                displaySequenceAnalysis(analysis);
            });
            
            // 排序路径
            sortPathsBtn.addEventListener('click', function() {
                const newPathsText = newPathsInput.value.trim();
                
                if (!newPathsText) {
                    alert('请输入新的TS路径列表');
                    return;
                }
                
                const newPaths = newPathsText.split('\n')
                    .map(path => path.trim())
                    .filter(path => path !== '');
                
                const sortedPaths = sortPathsByNumber(newPaths);
                newPathsInput.value = sortedPaths.join('\n');
                
                // 更新显示
                displayPaths(sortedPaths, newPathsList);
                
                // 重新分析序列
                const analysis = analyzePathSequence(sortedPaths);
                displaySequenceAnalysis(analysis);
            });
            
            // 分析路径序列
            function analyzePathSequence(paths) {
                const numbers = [];
                
                // 提取每个路径中的数字
                paths.forEach(path => {
                    const number = extractNumberFromPath(path);
                    if (number !== null) {
                        numbers.push(number);
                    }
                });
                
                if (numbers.length === 0) {
                    return {
                        min: null,
                        max: null,
                        missing: [],
                        isComplete: false,
                        message: "未在路径中找到数字序列"
                    };
                }
                
                // 找出最小和最大值
                const min = Math.min(...numbers);
                const max = Math.max(...numbers);
                
                // 找出缺失的数字
                const missing = [];
                for (let i = min; i <= max; i++) {
                    if (!numbers.includes(i)) {
                        missing.push(i);
                    }
                }
                
                const isComplete = missing.length === 0;
                
                return {
                    min,
                    max,
                    missing,
                    isComplete,
                    numbers
                };
            }
            
            // 从路径中提取数字
            function extractNumberFromPath(path) {
                // 尝试从下划线后提取数字
                const underscoreMatch = path.match(/_(\d+)(?:\D|$)/);
                if (underscoreMatch) {
                    return parseInt(underscoreMatch[1]);
                }
                
                // 尝试从文件名中提取数字
                const filenameMatch = path.match(/(\d+)(?:\.\w+)?(?:\?|$)/);
                if (filenameMatch) {
                    return parseInt(filenameMatch[1]);
                }
                
                return null;
            }
            
            // 按数字排序路径
            function sortPathsByNumber(paths) {
                return paths.sort((a, b) => {
                    const numA = extractNumberFromPath(a);
                    const numB = extractNumberFromPath(b);
                    
                    if (numA === null && numB === null) return 0;
                    if (numA === null) return 1;
                    if (numB === null) return -1;
                    
                    return numA - numB;
                });
            }
            
            // 显示序列分析结果
            function displaySequenceAnalysis(analysis) {
                if (!analysis.min && !analysis.max) {
                    sequenceResult.innerHTML = `<span class="missing-numbers">${analysis.message}</span>`;
                    return;
                }
                
                let html = `数字范围: ${analysis.min} - ${analysis.max}<br>`;
                html += `总数量: ${analysis.numbers.length}<br>`;
                
                if (analysis.isComplete) {
                    html += `<span class="complete-sequence">序列完整，无缺失数字</span>`;
                } else {
                    html += `<span class="missing-numbers">缺失数字: ${analysis.missing.join(', ')}</span><br>`;
                    html += `实际数量: ${analysis.numbers.length}，应有数量: ${analysis.max - analysis.min + 1}`;
                }
                
                sequenceResult.innerHTML = html;
            }
            
            // 更新范围信息
            function updateRangeInfo() {
                const startIndex = parseInt(startIndexInput.value) || 1;
                const endIndex = parseInt(endIndexInput.value) || tsPaths.length;
                
                if (startIndex < 1) startIndexInput.value = 1;
                if (endIndex > tsPaths.length) endIndexInput.value = tsPaths.length;
                
                const effectiveStart = Math.max(1, startIndex);
                const effectiveEnd = Math.min(tsPaths.length, endIndex);
                
                if (effectiveStart > effectiveEnd) {
                    rangeInfo.textContent = `范围设置无效: 起始序号(${effectiveStart}) 不能大于结束序号(${effectiveEnd})`;
                    rangeInfo.style.color = 'red';
                } else if (effectiveStart === 1 && effectiveEnd === tsPaths.length) {
                    rangeInfo.textContent = `默认替换全部 ${tsPaths.length} 个TS文件路径`;
                    rangeInfo.style.color = 'green';
                } else {
                    rangeInfo.textContent = `将替换第 ${effectiveStart} 到第 ${effectiveEnd} 个TS文件路径 (共 ${effectiveEnd - effectiveStart + 1} 个)`;
                    rangeInfo.style.color = 'blue';
                }
            }
            
            // 监听范围输入变化
            startIndexInput.addEventListener('input', updateRangeInfo);
            endIndexInput.addEventListener('input', updateRangeInfo);
            
            // 提取TS路径函数
            function extractTSPaths(m3u8Content) {
                const lines = m3u8Content.split('\n');
                const tsPaths = [];
                
                lines.forEach(line => {
                    // 跳过注释行和空行
                    if (line.startsWith('#') || line.trim() === '') {
                        return;
                    }
                    
                    // 检查是否是有效的媒体文件行
                    // 这里放宽条件，不限于.ts后缀
                    if (isMediaFileLine(line)) {
                        tsPaths.push(line);
                    }
                });
                
                return tsPaths;
            }
            
            // 判断是否为媒体文件行
            function isMediaFileLine(line) {
                // 排除明显的非媒体文件行
                if (line.startsWith('#') || line.trim() === '') {
                    return false;
                }
                
                // 常见的媒体文件扩展名
                const mediaExtensions = [
                    '.ts', '.m4s', '.mp4', '.m4v', '.mov', 
                    '.avi', '.mkv', '.webm', '.flv', '.3gp'
                ];
                
                // 检查是否包含常见媒体扩展名
                for (const ext of mediaExtensions) {
                    if (line.toLowerCase().includes(ext)) {
                        return true;
                    }
                }
                
                // 如果没有扩展名，检查是否是URL格式
                if (line.includes('://') && 
                    (line.includes('/') || line.includes('?'))) {
                    return true;
                }
                
                // 如果以上都不符合，可能是无后缀的TS文件
                // 检查是否是相对路径或简单文件名
                if (!line.includes('://') && 
                    (line.includes('/') || 
                     line.match(/^[a-zA-Z0-9_-]+(\.[a-zA-Z0-9]+)?$/))) {
                    return true;
                }
                
                return false;
            }
            
            // 显示路径列表
            function displayPaths(paths, container) {
                if (paths.length === 0) {
                    container.innerHTML = '<div class="path-entry">未检测到TS文件路径</div>';
                    return;
                }
                
                container.innerHTML = '';
                paths.forEach((path, index) => {
                    const pathElement = document.createElement('div');
                    pathElement.className = 'path-entry';
                    const number = extractNumberFromPath(path);
                    const numberText = number !== null ? ` [${number}]` : '';
                    pathElement.textContent = `${index + 1}. ${path}${numberText}`;
                    container.appendChild(pathElement);
                });
            }
            
            // 更新新路径列表显示
            newPathsInput.addEventListener('input', function() {
                const newPaths = newPathsInput.value.split('\n')
                    .map(path => path.trim())
                    .filter(path => path !== '');
                
                displayPaths(newPaths, newPathsList);
            });
            
            // 替换路径函数
            replaceBtn.addEventListener('click', function() {
                const m3u8Content = m3u8Input.value.trim();
                const newPathsText = newPathsInput.value.trim();
                
                if (!m3u8Content) {
                    alert('请输入M3U8文件内容');
                    return;
                }
                
                if (!newPathsText) {
                    alert('请输入新的TS路径列表');
                    return;
                }
                
                // 获取替换范围
                const startIndex = parseInt(startIndexInput.value) || 1;
                const endIndex = parseInt(endIndexInput.value) || tsPaths.length;
                
                if (startIndex < 1 || startIndex > tsPaths.length) {
                    alert('起始序号无效');
                    return;
                }
                
                if (endIndex < 1 || endIndex > tsPaths.length) {
                    alert('结束序号无效');
                    return;
                }
                
                if (startIndex > endIndex) {
                    alert('起始序号不能大于结束序号');
                    return;
                }
                
                // 按行分割M3U8内容
                const lines = m3u8Content.split('\n');
                
                // 按行分割新路径
                const newPaths = newPathsText.split('\n')
                    .map(path => path.trim())
                    .filter(path => path !== '');
                
                // 检查路径数量是否匹配
                const rangeCount = endIndex - startIndex + 1;
                if (newPaths.length !== rangeCount) {
                    alert(`错误：替换范围内有 ${rangeCount} 个TS文件，但您提供了 ${newPaths.length} 个新路径。数量必须相同。`);
                    return;
                }
                
                // 处理每一行
                let pathIndex = 0;
                let replacedCount = 0;
                const newLines = lines.map(line => {
                    // 跳过注释行和空行
                    if (line.startsWith('#') || line.trim() === '') {
                        return line;
                    }
                    
                    // 检查是否是媒体文件行
                    if (isMediaFileLine(line)) {
                        pathIndex++;
                        
                        // 检查是否在替换范围内
                        if (pathIndex >= startIndex && pathIndex <= endIndex) {
                            const newLineIndex = pathIndex - startIndex;
                            if (newLineIndex < newPaths.length) {
                                const newLine = newPaths[newLineIndex];
                                replacedCount++;
                                return newLine;
                            }
                        }
                    }
                    
                    return line;
                });
                
                // 更新输出
                m3u8Output.value = newLines.join('\n');
                resultStats.textContent = `成功替换了 ${replacedCount} 个TS文件路径 (第 ${startIndex} 到第 ${endIndex} 个)`;
            });
            
            // 复制结果
            copyBtn.addEventListener('click', function() {
                if (!m3u8Output.value) {
                    alert('没有内容可复制');
                    return;
                }
                
                m3u8Output.select();
                document.execCommand('copy');
                
                // 显示复制成功提示
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '已复制!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            });
            
            // 下载功能
            downloadBtn.addEventListener('click', function() {
                if (!m3u8Output.value) {
                    alert('没有内容可下载');
                    return;
                }
                
                // 显示下载对话框
                downloadModal.style.display = 'flex';
                filenameInput.focus();
                filenameInput.select();
            });
            
            // 确认下载
            confirmDownload.addEventListener('click', function() {
                const filename = filenameInput.value.trim();
                if (!filename) {
                    alert('请输入文件名');
                    return;
                }
                
                // 确保文件名以.m3u8结尾
                const finalFilename = filename.endsWith('.m3u8') ? filename : `${filename}.m3u8`;
                
                // 创建Blob并下载
                const blob = new Blob([m3u8Output.value], { type: 'application/vnd.apple.mpegurl' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = finalFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // 关闭对话框
                downloadModal.style.display = 'none';
            });
            
            // 取消下载
            cancelDownload.addEventListener('click', function() {
                downloadModal.style.display = 'none';
            });
            
            // 点击模态框外部关闭
            downloadModal.addEventListener('click', function(e) {
                if (e.target === downloadModal) {
                    downloadModal.style.display = 'none';
                }
            });
            
            // 清空内容
            clearBtn.addEventListener('click', function() {
                m3u8Input.value = '';
                m3u8Output.value = '';
                newPathsInput.value = '';
                fileUpload.value = '';
                startIndexInput.value = '1';
                endIndexInput.value = '';
                resultStats.textContent = '检测到0个TS文件路径';
                detectedPathsList.innerHTML = '<div class="path-entry">检测到的路径将显示在这里...</div>';
                newPathsList.innerHTML = '<div class="path-entry">新的路径将显示在这里...</div>';
                sequenceResult.innerHTML = '序列分析结果将显示在这里...';
                rangeInfo.textContent = '默认替换全部TS文件路径';
                rangeInfo.style.color = 'inherit';
            });
            
            // 示例M3U8内容（包含无后缀TS文件）
            m3u8Input.value = `#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:10
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:10.0,
http://example.com/oldpath/segment0.ts
#EXTINF:10.0,
http://example.com/oldpath/segment1
#EXTINF:10.0,
/relative/path/segment2.m4s
#EXTINF:10.0,
segment3
#EXTINF:10.0,
https://cdn.example.com/videos/segment4.ts?token=abc123
#EXT-X-ENDLIST`;
            
            // 示例新路径（包含不连续序列）
            newPathsInput.value = `https://cdn.example.com/videos/seg_5.ts
https://cdn.example.com/videos/seg_2.m4s
https://cdn.example.com/videos/seg_1
https://cdn.example.com/videos/seg_4.ts?token=new123
https://cdn.example.com/videos/seg_3`;
            
            // 初始分析
            analyzeBtn.click();
        });
    </script>
</body>
</html>